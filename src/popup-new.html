<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Phevere Dictionary</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

             body {
         font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
         background: #ffffff;
         color: #333;
         overflow: hidden;
         height: 100vh;
         user-select: text;
          margin: 0; /* remove any default margin to keep toolbar slim */
          padding: 0; /* ensure no outer padding */
         border: none;
       }

       .popup-container {
         height: 100vh;
         display: flex;
         flex-direction: column;
         background: #ffffff;
         border: none;
         border-radius: 0;
         box-shadow: none;
         margin: 0;
         padding: 0;
       }

      /* Toolbar */
       .toolbar {
          display: flex;
          align-items: center;
           justify-content: flex-start; /* align icons to the left for no empty gap */
          padding: 0 8px; /* zero vertical padding for razor-slim bar */
          background: transparent; /* no bar background */
          border-bottom: none;
          min-height: 28px; /* shorter */
          -webkit-app-region: drag; /* Make toolbar draggable */
          cursor: move;
          position: relative; /* for dropdown anchoring */
        }

       .toolbar-icon {
         -webkit-app-region: no-drag; /* Prevent icons from being draggable */
       }

      .toolbar.collapsed { padding: 0 8px; min-height: 28px; }

      .toolbar-left { display: none; }

      .toolbar-title {
        font-size: 16px;
        font-weight: 600;
        color: #2d3748;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .toolbar.collapsed .toolbar-title {
        opacity: 0;
        width: 0;
        overflow: hidden;
      }

      .toolbar-icons { display: flex; align-items: center; gap: 8px; }

      .toolbar-icon {
        width: 26px; /* larger, modern */
        height: 26px;
        border: none;
        background: rgba(255,255,255,0.6); /* subtle reflective plate */
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.15s ease, background 0.15s ease;
        color: #4b5563;
        font-size: 16px;
        box-shadow: none;
        user-select: none;
      }

      .toolbar-icon:hover { background: rgba(255,255,255,0.85); color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }

      /* Add slim separators between icon groups */
      .toolbar-icons button + button::before {
        content: '';
        display: inline-block;
        width: 1px;
        height: 14px;
        margin: 0 6px 0 0;
        background: rgba(0,0,0,0.06);
      }

      .toolbar-icon.active { background: rgba(59,130,246,.15); color: #1d4ed8; }

      /* Prevent accidental text selection in the toolbar/tabs */
      .toolbar, .toolbar * , .tabs, .tabs * { user-select: none; }

      /* Results Area */
      .results-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 1;
        transform: translateY(0);
        padding: 0; /* remove bottom padding */
        margin: 0;  /* remove extra margins */
      }

      .results-area.collapsed {
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
         height: 0;
         padding: 0;
         margin: 0;
      }

      /* Input Section removed for slim toolbar */
      .input-section { display: none; }

      .text-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        color: #2d3748;
        background: #ffffff;
        transition: all 0.2s ease;
        outline: none;
      }

      .text-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Tabs */
      .tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #e1e5e9;
        padding: 0 16px;
      }

      .tab {
        padding: 12px 16px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #64748b;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
      }

      .tab:hover {
        color: #475569;
        background: #f1f5f9;
      }

      .tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
        background: #ffffff;
      }

      /* Results Section */
      .results-section {
         flex: 1;
         overflow-y: auto;
         padding: 0 10px 6px 10px; /* tighter */
         background: #ffffff;
       }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: #64748b;
        font-style: italic;
      }

      .loading::after {
        content: '';
        width: 16px;
        height: 16px;
        border: 2px solid #e2e8f0;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Dictionary Results */
      .dictionary-results {
        display: none;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .result-card {
        background: #ffffff;
        border: 1px solid #e1e5e9;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .result-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .result-icon {
        width: 32px;
        height: 32px;
        background: #10b981;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-size: 14px;
        font-weight: 600;
      }

      .result-meta {
        flex: 1;
      }

      .result-source {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 4px;
      }

      .result-confidence {
        font-size: 12px;
        color: #10b981;
        font-weight: 500;
      }

             .result-original {
         font-size: 14px;
         color: #64748b;
         font-style: italic;
         margin-bottom: 8px;
         padding: 8px 12px;
         background: #f1f5f9;
         border-radius: 6px;
         border-left: 3px solid #94a3b8;
       }

       .result-word {
         font-size: 24px;
         font-weight: 700;
         color: #1e293b;
         margin-bottom: 8px;
       }

      .result-pronunciation {
        color: #64748b;
        font-size: 14px;
        font-family: 'Courier New', monospace;
        margin-bottom: 16px;
      }

      .result-section {
        margin-bottom: 20px;
      }

      .result-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .definition-item {
        background: #f8f9fa;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid #3b82f6;
      }

      .definition-pos {
        color: #10b981;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 4px;
      }

             .definition-text {
         color: #1e293b;
         line-height: 1.5;
         cursor: pointer;
         user-select: text;
       }

       .definition-text:hover {
         background: #f1f5f9;
         border-radius: 4px;
         padding: 2px 4px;
       }

      .translation-item {
        background: #f8f9fa;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid #f59e0b;
      }

      .translation-lang {
        color: #f59e0b;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .example-item {
        background: #f8f9fa;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid #8b5cf6;
        font-style: italic;
        color: #475569;
      }

      /* Enhanced Etymology Styling */
      .etymology-container {
        margin-bottom: 16px;
        background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .etymology-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
      }

      .etymology-icon {
        font-size: 16px;
      }

      .etymology-title {
        flex: 1;
      }

      .etymology-content {
        padding: 16px 20px;
        background: linear-gradient(135deg, #fef7ed 0%, #fef3c7 100%);
        border-left: 4px solid #f59e0b;
      }

      .etymology-text {
        line-height: 1.6;
        font-size: 14px;
        color: #92400e;
      }

      .etymology-sentence {
        margin-bottom: 8px;
        padding: 4px 0;
      }

      .etymology-keyword {
        color: #dc2626;
        font-weight: 600;
        background: rgba(220, 38, 38, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 13px;
      }

      .etymology-language {
        color: #7c3aed;
        font-weight: 600;
        background: rgba(124, 58, 237, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-style: italic;
        font-size: 13px;
      }

      .etymology-pos {
        color: #059669;
        font-weight: 600;
        background: rgba(5, 150, 105, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        text-transform: uppercase;
      }

      .etymology-no-data {
        padding: 20px;
        text-align: center;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-left: 4px solid #64748b;
      }

      .no-data-icon {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.6;
      }

      .no-data-text {
        color: #64748b;
      }

      .no-data-text ul {
        text-align: left;
        margin: 12px 0;
        padding-left: 20px;
      }

      .no-data-text li {
        margin: 6px 0;
        font-size: 13px;
      }

      .no-data-text em {
        color: #475569;
        font-style: italic;
      }

      /* Legacy support for old etymology styling */
      .etymology-info {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 8px;
        border-left: 4px solid #f59e0b;
        color: #92400e;
        line-height: 1.5;
        font-size: 14px;
      }

      .etymology-info ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .etymology-info li {
        margin: 4px 0;
      }

      .etymology-info small {
        color: #a16207;
        font-style: italic;
      }

      .result-actions {
        display: flex;
        gap: 8px;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #e1e5e9;
      }

      .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .action-btn-primary {
        background: #3b82f6;
        color: #ffffff;
      }

      .action-btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }

      .action-btn-secondary {
        background: #10b981;
        color: #ffffff;
      }

      .action-btn-secondary:hover {
        background: #059669;
        transform: translateY(-1px);
      }

      .action-btn-info {
        background: #8b5cf6;
        color: #ffffff;
      }

      .action-btn-info:hover {
        background: #7c3aed;
        transform: translateY(-1px);
      }

      .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
        font-style: italic;
      }

      /* Settings Panel */
       .settings-panel {
         position: absolute; /* anchor within popup to avoid overflowing viewport */
         top: 32px;
         right: 8px;
        background: #ffffff;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 16px;
        min-width: 200px;
        z-index: 1000;
        display: none;
      }

      .settings-panel.show {
        display: block;
        animation: fadeIn 0.2s ease-in;
      }

      .setting-item {
        margin-bottom: 12px;
      }

      .setting-item:last-child {
        margin-bottom: 0;
      }

      .setting-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #475569;
        cursor: pointer;
      }

      /* Provide a visible close affordance for settings panel */
      .settings-panel::after {
        content: '√ó';
        position: absolute;
        top: 6px;
        right: 8px;
        width: 18px;
        height: 18px;
        line-height: 18px;
        text-align: center;
        border-radius: 4px;
        color: #fff;
        background: #111827;
        cursor: pointer;
      }
      .settings-panel:hover::after { background: #374151; }

             .setting-checkbox {
         width: 16px;
         height: 16px;
         accent-color: #3b82f6;
       }

       /* Language Selection */
       .language-selection {
         padding: 16px;
         background: #f8f9fa;
         border-bottom: 1px solid #e1e5e9;
       }

       .language-row {
         display: flex;
         gap: 16px;
         align-items: center;
       }

       .language-group {
         display: flex;
         flex-direction: column;
         gap: 4px;
       }

       .language-group label {
         font-size: 12px;
         font-weight: 600;
         color: #475569;
         text-transform: uppercase;
         letter-spacing: 0.5px;
       }

       .language-select {
         padding: 8px 12px;
         border: 2px solid #e2e8f0;
         border-radius: 6px;
         font-size: 14px;
         background: #ffffff;
         color: #2d3748;
         cursor: pointer;
         transition: all 0.2s ease;
       }

       .language-select:focus {
         border-color: #3b82f6;
         outline: none;
         box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
       }

       /* Audio Button */
       .audio-button {
         width: 32px;
         height: 32px;
         border: none;
         background: #10b981;
         border-radius: 6px;
         cursor: pointer;
         display: flex;
         align-items: center;
         justify-content: center;
         color: #ffffff;
         font-size: 16px;
         transition: all 0.2s ease;
         margin-left: 8px;
       }

       .audio-button:hover {
         background: #059669;
         transform: translateY(-1px);
       }
    </style>
  </head>
  <body>
    <div class="popup-container">
      <!-- Settings Panel -->
          <div class="settings-panel" id="settingsPanel">
        <div class="setting-item">
          <label class="setting-label">
            <input type="checkbox" class="setting-checkbox" id="expandableMode">
            <span>Expandable toolbar mode</span>
          </label>
        </div>
        <div class="setting-item">
          <label class="setting-label">
            <input type="checkbox" class="setting-checkbox" id="preloadContent">
            <span>Preload dictionary content</span>
          </label>
        </div>
        <div class="setting-item">
          <label class="setting-label">
            <input type="checkbox" class="setting-checkbox" id="openExternalLinks">
             <span>Open links in external browser</span>
          </label>
        </div>
      </div>

      <!-- Toolbar: always visible slim strip -->
      <div class="toolbar" id="toolbar">
          <div class="toolbar-left">
            <div class="toolbar-title">Phevere Dictionary</div>
          </div>
          <div class="toolbar-icons">
            <button class="toolbar-icon" id="dictionaryIcon" title="Dictionary">üìñ</button>
            <button class="toolbar-icon" id="translationIcon" title="Translation">üåê</button>
            <button class="toolbar-icon" id="wikiIcon" title="Wikipedia">üÖÜ</button>
            <button class="toolbar-icon" id="audioIcon" title="Play Audio">üîä</button>
            <button class="toolbar-icon" id="clipboardIcon" title="Clipboard">üìã</button>
            <button class="toolbar-icon" id="searchIcon" title="Search">üîç</button>
            <button class="toolbar-icon" id="settingsIcon" title="Settings">‚öôÔ∏è</button>
            <button class="toolbar-icon" id="closeIcon" title="Close">‚úï</button>
          </div>
        </div>

      <!-- Results Area (collapsible) -->
      <div class="results-area" id="resultsArea">
        <!-- Language Selection for Translation -->
         <div class="language-selection" id="languageSelection" style="display: none;">
           <div class="language-row">
             <div class="language-group">
               <label>From:</label>
               <select id="sourceLanguage" class="language-select">
                 <option value="auto">Auto Detect</option>
                 <option value="en" selected>English</option>
                 <option value="zh">Chinese</option>
                 <option value="es">Spanish</option>
                 <option value="fr">French</option>
                 <option value="de">German</option>
                 <option value="ja">Japanese</option>
                 <option value="ko">Korean</option>
                 <option value="ru">Russian</option>
               </select>
             </div>
             <div class="language-group">
               <label>To:</label>
               <select id="targetLanguage" class="language-select">
                 <option value="en">English</option>
                 <option value="zh" selected>Chinese</option>
                 <option value="es">Spanish</option>
                 <option value="fr">French</option>
                 <option value="de">German</option>
                 <option value="ja">Japanese</option>
                 <option value="ko">Korean</option>
                 <option value="ru">Russian</option>
               </select>
             </div>
           </div>
         </div>

         <!-- Tabs -->
         <div class="tabs" id="tabsContainer" style="display: none;">
           <button class="tab active" data-tab="translation">Translation</button>
                       <button class="tab" data-tab="dictionary">Free Dictionary API</button>
            <button class="tab" data-tab="wiktionary">Wiktionary</button>
            <button class="tab" data-tab="etymology">üìö Etymology</button>
         </div>

        <!-- Results Section -->
        <div class="results-section">
          <div class="loading" id="loadingElement">
            Looking up definition...
          </div>
          
          <div class="dictionary-results" id="dictionary-results">
            <!-- Dictionary results will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      console.log('[POPUP] Script tag loaded - popup-new.html is being executed!');
      // Global variables
      let currentText = '';
      let currentResult = null;
      let currentTab = 'dictionary';
      let isExpanded = false; // start collapsed
      let settings = {
        expandableMode: true,
        preloadContent: true,
        openExternal: false
      };

      // Initialize when the DOM is ready
      console.log('[POPUP] DOMContentLoaded event fired');
      document.addEventListener('DOMContentLoaded', initialize);

             // Main initialization function
       async function initialize() {
         console.log('[POPUP] Initialize function called');
         console.log('[POPUP] DOM ready, setting up popup...');
         
         loadSettings();
         console.log('[POPUP] Settings loaded:', settings);
         
         setupEventListeners();
         console.log('[POPUP] Event listeners set up');
         
          // Old behavior: sharp tool strip by default (collapsed) and expand only when icon/tab clicked
          setupToolbarBehavior();
          collapseToolbar();

        // This is the CRITICAL FIX:
        // Actively fetch the last selected text from the main process
          if (window.electronAPI) {
            try {
              const selectionEvent = await window.electronAPI.getLastSelection();
              if (selectionEvent && selectionEvent.text) {
                currentText = selectionEvent.text;
                window['__popupCurrentText'] = currentText;
                const openedFromHistory = (window.outerWidth || 0) > 600;
                if (openedFromHistory) {
                  // Historical popup (expanded window) ‚Äì auto-expand and run lookup once
                  activateTab('dictionary');
                  expandToolbar();
                  lookupText(currentText);
                } else {
                  // Slim popup ‚Äì stay collapsed
                  activateTab('dictionary');
                }
              }
            } catch (e) {}
          }
      }

      // Listen for popup-text push from main
      try {
        if (window.electronAPI && typeof window.electronAPI.onPopupText === 'function') {
          console.log('[POPUP] Registering onPopupText listener');
          window.electronAPI.onPopupText((text) => {
            console.log('[POPUP] onPopupText:', text);
            currentText = text || currentText;
          });
        } else {
          console.log('[POPUP] electronAPI.onPopupText not available');
        }
      } catch (e) {
        console.error('[POPUP] Failed to register onPopupText:', e);
      }

      // Load settings from localStorage
      function loadSettings() {
        const savedSettings = localStorage.getItem('phevereSettings');
        if (savedSettings) {
          settings = { ...settings, ...JSON.parse(savedSettings) };
        }
        
        document.getElementById('expandableMode').checked = settings.expandableMode;
        document.getElementById('preloadContent').checked = settings.preloadContent;
        const openExternalLinks = document.getElementById('openExternalLinks');
        if (openExternalLinks) openExternalLinks.checked = settings.openExternal;
      }

      // Save settings to localStorage
      function saveSettings() {
        localStorage.setItem('phevereSettings', JSON.stringify(settings));
      }

             // Setup event listeners for all UI elements
       function setupEventListeners() {
         // Toolbar icons
            document.getElementById('dictionaryIcon').addEventListener('click', () => { 
              activateTab('dictionary');
              expandToolbar();
              const t = currentText || window['__popupCurrentText'] || '';
              if (t) lookupText(t);
          });
             document.getElementById('translationIcon').addEventListener('click', () => { 
               activateTab('translation');
               expandToolbar();
               const t = currentText || window['__popupCurrentText'] || '';
               if (t) lookupText(t);
           });
            document.getElementById('wikiIcon').addEventListener('click', async () => {
                if (!currentText) return;
                try {
                  // Open in a separate app window to avoid clashing with dictionary tab
                  if (window.electronAPI && window.electronAPI.send) {
                    window.electronAPI.send('open-wiki', currentText);
                  } else {
                    await showWikipediaPanel(currentText);
                  }
                } catch (error) {
                  console.error('[POPUP] Wikipedia button error:', error.message || 'Unknown error');
                  showToast('Failed to open Wikipedia');
                }
            });
            document.getElementById('audioIcon').addEventListener('click', () => {
               console.log('[POPUP] Audio button clicked');
               if (currentText) {
                     const lang = window['__audioLang'] || 'en';
                    playAudio(currentText, lang);
               }
           });
            document.getElementById('clipboardIcon').addEventListener('click', async () => {
               console.log('[POPUP] Clipboard copy button clicked');
               if (currentText && window.clipboardAPI && window.clipboardAPI.copy) {
                   await window.clipboardAPI.copy(currentText);
                   showToast('Copied');
               }
           });
            document.getElementById('searchIcon').addEventListener('click', () => {
              console.log('[POPUP] Search button clicked');
              if (currentText && window.electronAPI && window.electronAPI.send) {
                  // create independent window for search
                  const url = `https://www.google.com/search?q=${encodeURIComponent(currentText)}`;
                  window.electronAPI.send('open-in-app', url);
              }
            });
            document.getElementById('closeIcon').addEventListener('click', () => {
              console.log('[POPUP] Close clicked');
              window.close();
            });
           document.getElementById('settingsIcon').addEventListener('click', () => {
              console.log('[POPUP] Settings button clicked');
              // Always show quick settings panel even when collapsed
              if (!isExpanded) {
                const toolbar = document.getElementById('toolbar');
                toolbar.classList.remove('collapsed');
              }
              toggleSettingsPanel();
              // Ensure the popup grows to fit the panel (so it won't be clipped)
              const p = document.getElementById('settingsPanel');
              if (p && p.classList.contains('show') && window.electronAPI && window.electronAPI.resizeWindow) {
                // Calculate a comfortable height
                const desiredHeight = 200; // toolbar (36) + panel + margin
                window.electronAPI.resizeWindow(320, Math.max(120, desiredHeight));
              }
           });

        // Settings
        document.getElementById('expandableMode').addEventListener('change', (e) => {
          settings.expandableMode = e.target.checked;
          saveSettings();
          setupToolbarBehavior();
        });
        document.getElementById('preloadContent').addEventListener('change', (e) => {
          settings.preloadContent = e.target.checked;
          saveSettings();
        });
        const openExternalLinks = document.getElementById('openExternalLinks');
        if (openExternalLinks) {
          openExternalLinks.addEventListener('change', (e) => {
            settings.openExternal = e.target.checked;
            window.openLinksExternally = settings.openExternal;
            saveSettings();
          });
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => activateTab(tab.dataset.tab));
        });

        // No text input in slim design

                 // Handle Escape key
         document.addEventListener('keydown', (e) => {
           if (e.key === 'Escape') window.close();
         });

                   // Add text selection and lookup functionality - create new popup instead of reusing
          document.addEventListener('mouseup', function(evt) {
            const selection = window.getSelection();
            const target = evt.target || null;
            var inResults = null;
            if (target && typeof target.closest === 'function') {
              inResults = target.closest('.results-section');
            }
            if (inResults && selection && selection.toString().trim()) {
              const selectedText = selection.toString().trim();
              console.log('[POPUP] Text selected:', selectedText);
              
              // Store selected text for potential lookup
              if (selectedText.length > 0 && selectedText.length < 100) {
                currentText = selectedText;
              }
            }
          });

          // Add double-click to lookup selected text in current popup
          document.addEventListener('dblclick', function(e) {
            const selection = window.getSelection();
            const target = e.target || null;
            var inResults = null;
            if (target && typeof target.closest === 'function') {
              inResults = target.closest('.results-section');
            }
            if (inResults && selection && selection.toString().trim()) {
              const selectedText = selection.toString().trim();
              console.log('[POPUP] Double-clicked text:', selectedText);
              
              if (selectedText.length > 0 && selectedText.length < 100) {
                currentText = selectedText;
                lookupText(currentText);
              }
            }
          });
      }

      // Toolbar behavior logic
      function setupToolbarBehavior() {
        const toolbar = document.getElementById('toolbar');
          const clickHandler = (e) => {
          const onIcons = !!e.target.closest('.toolbar-icons');
          if (!onIcons && !isExpanded) {
            expandToolbar();
          }
        };
        // Clear previous listener before adding a new one
          toolbar.removeEventListener('click', clickHandler);
          if (settings.expandableMode) {
            toolbar.addEventListener('click', clickHandler);
          } else {
            expandToolbar(); // Always expand if not in expandable mode
          }
      }

             // Enhanced etymology display function with professional formatting
        function displayEtymologyResult(result) {
          console.log('[POPUP] displayEtymologyResult called with:', result);
          document.getElementById('loadingElement').style.display = 'none';
          const resultsContainer = document.getElementById('dictionary-results');
          resultsContainer.style.display = 'block';

          let etymologyHtml = '';

          if (result.etymology && result.etymology.length > 0) {
            // Parse and format the etymology text
            const formattedEtymology = formatEtymologyText(result.etymology);

            etymologyHtml = `
              <div class="result-card">
                  <div class="result-word">${result.word}</div>
                  <div class="etymology-container">
                    <div class="etymology-header">
                      <span class="etymology-icon">üìö</span>
                      <span class="etymology-title">Word Origin & Etymology</span>
                    </div>
                    <div class="etymology-content">
                      ${formattedEtymology}
                    </div>
                  </div>
                  <div class="result-actions">
                      <button onclick="playAudio('${result.word}', 'en')" class="audio-button" title="Play pronunciation">üîä</button>
                      <button onclick="searchWeb('${result.word}')" class="action-btn action-btn-info">üîç Search Web</button>
                  </div>
              </div>`;
          } else {
            etymologyHtml = `
              <div class="result-card">
                  <div class="result-word">${result.word}</div>
                  <div class="etymology-container">
                    <div class="etymology-header">
                      <span class="etymology-icon">üìö</span>
                      <span class="etymology-title">Word Origin & Etymology</span>
                    </div>
                    <div class="etymology-no-data">
                      <div class="no-data-icon">‚ùì</div>
                      <div class="no-data-text">
                        <p><strong>No etymology information found</strong></p>
                        <p>This may be because:</p>
                        <ul>
                          <li>The word is too recent or technical</li>
                          <li>The word originates from a language not well-documented in etymology databases</li>
                          <li>The term is a proper name or acronym</li>
                        </ul>
                        <p><em>Try searching for the root word or related terms for better results.</em></p>
                      </div>
                    </div>
                  </div>
                  <div class="result-actions">
                      <button onclick="playAudio('${result.word}', 'en')" class="audio-button" title="Play pronunciation">üîä</button>
                      <button onclick="searchWeb('${result.word}')" class="action-btn action-btn-info">üîç Search Web</button>
                  </div>
              </div>`;
          }

          resultsContainer.innerHTML = etymologyHtml;
          console.log('[POPUP] Enhanced etymology content displayed');
        }

        // Format etymology text with professional styling
        function formatEtymologyText(etymologyText) {
          if (!etymologyText) return '';

          // Split into sentences for better formatting
          const sentences = etymologyText.split(/[.!?]+/).filter(s => s.trim().length > 3);

          let formattedHtml = '<div class="etymology-text">';

          sentences.forEach((sentence, index) => {
            const trimmedSentence = sentence.trim();
            if (trimmedSentence) {
              // Highlight key linguistic terms
              let highlightedSentence = trimmedSentence
                .replace(/\b(From|Derived from|Borrowed from|Inherited from|Root|Origin|Etymology)\b/gi, '<span class="etymology-keyword">$1</span>')
                .replace(/\b(Latin|Greek|French|German|Old English|Middle English|Anglo-Saxon|Proto-Germanic|Indo-European)\b/gi, '<span class="etymology-language">$1</span>')
                .replace(/\b(verb|noun|adjective|adverb|pronoun|preposition|conjunction|interjection)\b/gi, '<span class="etymology-pos">$1</span>');

              formattedHtml += `<div class="etymology-sentence">${highlightedSentence}${index < sentences.length - 1 ? '.' : ''}</div>`;
            }
          });

          formattedHtml += '</div>';
          return formattedHtml;
        }

        // Collapse toolbar
       function collapseToolbar() {
         console.log('[POPUP] Collapsing toolbar...');
         if (!settings.expandableMode) {
           console.log('[POPUP] Expandable mode disabled, not collapsing');
           return;
         }
         
          const toolbar = document.getElementById('toolbar');
          const resultsArea = document.getElementById('resultsArea');
         
         console.log('[POPUP] Adding collapsed classes...');
          toolbar.classList.add('collapsed');
          resultsArea.classList.add('collapsed');
         isExpanded = false;
         
         console.log('[POPUP] Toolbar collapsed, isExpanded:', isExpanded);
       }

       // Expand toolbar
       function expandToolbar() {
         console.log('[POPUP] Expanding toolbar...');
          const toolbar = document.getElementById('toolbar');
          const resultsArea = document.getElementById('resultsArea');
         
         console.log('[POPUP] Removing collapsed classes...');
          toolbar.classList.remove('collapsed');
          resultsArea.classList.remove('collapsed');
         isExpanded = true;
         
         console.log('[POPUP] Toolbar expanded, isExpanded:', isExpanded);
         
         // Resize window to accommodate expanded content
         if (window.electronAPI && window.electronAPI.resizeWindow) {
           console.log('[POPUP] Resizing window for expanded content...');
           window.electronAPI.resizeWindow(400, 500);
         }
       }

      // Toggle settings panel
       function toggleSettingsPanel() {
         const p = document.getElementById('settingsPanel');
         p.classList.toggle('show');
       }

       // Close settings when clicking outside
        document.addEventListener('click', function(e) {
         const p = document.getElementById('settingsPanel');
         const btn = document.getElementById('settingsIcon');
         if (!p) return;
         if (!p.classList.contains('show')) return;
         const t = e.target;
         // Allow clicking the pseudo close button (panel ::after)
         const rect = p.getBoundingClientRect();
         var x = 0; var y = 0;
         var ev = e || {};
         if (typeof ev.clientX === 'number') x = ev.clientX;
         if (typeof ev.clientY === 'number') y = ev.clientY;
         const closeHit = x >= rect.right - 26 && x <= rect.right - 6 && y >= rect.top + 6 && y <= rect.top + 24;
         if ((p && typeof p.contains==='function' && p.contains(t)) || (btn && typeof btn.contains==='function' && btn.contains(t))) {
           if (!closeHit) return;
         }
         p.classList.remove('show');
       });

             function activateTab(tabName) {
         currentTab = tabName;
         document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
         document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
         document.querySelectorAll('.toolbar-icon').forEach(icon => icon.classList.remove('active'));
         
                   if (tabName === 'etymology') {
            document.getElementById('wikiIcon').classList.add('active');
          } else if (tabName.includes('dict')) {
            document.getElementById('dictionaryIcon').classList.add('active');
          } else {
            document.getElementById('translationIcon').classList.add('active');
          }
         
         // Show/hide language selection for translation
         const languageSelection = document.getElementById('languageSelection');
         const tabsContainer = document.getElementById('tabsContainer');
         
         if (tabName === 'translation') {
           languageSelection.style.display = 'block';
           tabsContainer.style.display = 'flex';
         } else {
           languageSelection.style.display = 'none';
           tabsContainer.style.display = 'flex';
         }
         
                   // Re-render content for the activated tab
          if(currentResult) {
            if (tabName === 'etymology') {
              displayEtymologyResult(currentResult);
            } else {
              displayDictionaryResult(currentResult);
            }
          }
       }

                           async function lookupText(text) {
          if (!text.trim()) return;
          console.log('[POPUP] lookupText called with:', text, 'currentTab:', currentTab);
          showLoading();
          try {
            if (window.dictionaryAPI) {
              console.log('[POPUP] dictionaryAPI available, calling lookup...');
              
              // Get language settings for translation
              let sourceLang = 'en';
              let targetLang = 'zh';
              
              if (currentTab === 'translation') {
                const sourceSelect = document.getElementById('sourceLanguage');
                const targetSelect = document.getElementById('targetLanguage');
                if (sourceSelect) sourceLang = sourceSelect.value;
                if (targetSelect) targetLang = targetSelect.value;
                console.log('[POPUP] Translation mode - sourceLang:', sourceLang, 'targetLang:', targetLang);
              } else {
                console.log('[POPUP] Dictionary mode - using default languages');
              }
              
              console.log('[POPUP] Calling dictionaryAPI.lookup with:', text, targetLang);
              currentResult = await window.dictionaryAPI.lookup(text, targetLang);
              console.log('[POPUP] Dictionary lookup result:', currentResult);
              // Derive audio language: if metadata.detectedLanguage present, use it; else use target when translating, 'en' for dictionary
              var audioLang = (currentResult && currentResult.detectedLanguage) ? currentResult.detectedLanguage : (currentTab === 'translation' ? targetLang : 'en');
              window['__audioLang'] = audioLang;
              displayDictionaryResult(currentResult);
            } else {
              console.log('[POPUP] dictionaryAPI not available, using mock result');
              displayMockResult(text); // Fallback for dev
            }
          } catch (error) {
            console.error('[POPUP] Error in lookupText:', error);
            displayErrorResult(text, error);
          }
        }

      // Show loading
      function showLoading() {
        document.getElementById('loadingElement').style.display = 'flex';
        document.getElementById('dictionary-results').style.display = 'none';
      }

             function displayDictionaryResult(result) {
         console.log('[POPUP] displayDictionaryResult called with:', result);
         console.log('[POPUP] Current tab:', currentTab);
         
         document.getElementById('loadingElement').style.display = 'none';
         const resultsContainer = document.getElementById('dictionary-results');
         resultsContainer.style.display = 'block';

         let contentHtml = '';
         if (currentTab === 'translation') {
             console.log('[POPUP] Processing translation tab');
             console.log('[POPUP] Translations:', result.translations);
             contentHtml = (result.translations || []).map(t => createTranslationCard(result.word, t)).join('');
         } else {
             console.log('[POPUP] Processing dictionary tab:', currentTab);
             const sourceName = currentTab === 'dictionary' ? 'Free Dictionary API' : 'Wiktionary';
             console.log('[POPUP] Source name:', sourceName);
             console.log('[POPUP] Definitions:', result.definitions);
             contentHtml = createDefinitionCard(result, sourceName);
         }

         console.log('[POPUP] Generated content HTML length:', contentHtml.length);
         if (!contentHtml) {
             console.log('[POPUP] No content generated, showing error message');
             contentHtml = `<div class="error-message">No relevant data found for this tab.</div>`;
         }

          resultsContainer.innerHTML = contentHtml;
         console.log('[POPUP] Content displayed successfully');
       }

             function createTranslationCard(word, trans) {
         return `
           <div class="result-card">
             <div class="result-header">
               <div class="result-icon">${trans.language.toUpperCase()}</div>
               <div class="result-meta">
                 <div class="result-source">${trans.source || 'Translation Service'}</div>
                 ${trans.confidence ? `<div class="result-confidence">Confidence: ${Math.round(trans.confidence * 100)}%</div>` : ''}
               </div>
             </div>
             <div class="result-original">Original: ${word}</div>
             <div class="result-word">${trans.text}</div>
             ${trans.pronunciation ? `<div class="result-pronunciation">${trans.pronunciation}</div>` : ''}
                           <div class="result-actions">
                <button onclick="playAudio('${word}', 'en')" class="audio-button" title="Play original text pronunciation">üîä Original</button>
                <button onclick="playAudio('${trans.text}', '${trans.language}')" class="audio-button" title="Play translation pronunciation">üîä ${trans.language.toUpperCase()}</button>
                <button onclick="searchWeb('${trans.text}')" class="action-btn action-btn-info">üîç Search Web</button>
              </div>
           </div>
         `;
       }

                           function createDefinitionCard(result, source) {
            console.log('[POPUP] createDefinitionCard called with source:', source);
            console.log('[POPUP] Result definitions:', result.definitions);
            
            // Filter definitions by source
            let defs = [];
            if (source === 'Free Dictionary API') {
                defs = (result.definitions || []).filter(d => !d.source || d.source === 'Free Dictionary API' || d.source === 'freedictionaryapi');
            } else if (source === 'Wiktionary') {
                defs = (result.definitions || []).filter(d => d.source === 'Wiktionary' || d.source === 'wiktionary');
            }
            
            // If no filtered definitions, show all definitions
            if (defs.length === 0) {
                defs = result.definitions || [];
                console.log('[POPUP] No source-specific definitions, showing all:', defs.length);
            } else {
                console.log('[POPUP] Found source-specific definitions:', defs.length);
            }
            
            if (defs.length === 0) {
                console.log('[POPUP] No definitions found');
                return `<div class="error-message">No definitions found for ${source}.</div>`;
            }
            
            return `
            <div class="result-card">
                <div class="result-word">${result.word}</div>
                ${result.pronunciation ? `<div class="result-pronunciation">/${result.pronunciation}/</div>` : ''}
                <div class="result-section">
                  <div class="result-section-title">Definitions from ${source}</div>
                  ${defs.map(d => `
                      <div class="definition-item">
                          <div class="definition-pos">${d.partOfSpeech || 'Unknown'}</div>
                          <div class="definition-text">${d.meaning || d.definition || 'No definition available'}</div>
                      </div>
                  `).join('')}
                </div>
                ${result.etymology ? `
                  <div class="result-section">
                      <div class="result-section-title">Etymology</div>
                      <div class="example-item">${result.etymology}</div>
                  </div>` : ''
                }
                ${(result.examples && result.examples.length > 0) ? `
                  <div class="result-section">
                      <div class="result-section-title">Examples</div>
                      ${result.examples.map(ex => `<div class=\"example-item\"><em>"${ex}"</em></div>`).join('')}
                  </div>` : ''
                }
                ${(result.synonyms && result.synonyms.length > 0) ? `
                  <div class="result-section">
                      <div class="result-section-title">Synonyms</div>
                      <div class="example-item">${result.synonyms.join(', ')}</div>
                  </div>` : ''
                }
                ${(result.antonyms && result.antonyms.length > 0) ? `
                  <div class="result-section">
                      <div class="result-section-title">Antonyms</div>
                      <div class="example-item">${result.antonyms.join(', ')}</div>
                  </div>` : ''
                }
                <div class="result-actions">
                    <button onclick="playAudio('${result.word}', 'en')" class="audio-button" title="Play pronunciation">üîä</button>
                    <button onclick="searchWeb('${result.word}')" class="action-btn action-btn-info">üîç Search Web</button>
                </div>
            </div>`;
        }

      // Display mock result
      function displayMockResult(text) {
        document.getElementById('loadingElement').style.display = 'none';
        document.getElementById('dictionary-results').style.display = 'block';
        
        document.getElementById('dictionary-results').innerHTML = `
          <div class="result-card">
            <div class="result-header">
              <div class="result-icon">EN</div>
              <div class="result-meta">
                <div class="result-source">Mock Data</div>
                <div class="result-confidence">100%</div>
              </div>
            </div>
            <div class="result-word">${text}</div>
            <div class="result-pronunciation">/h…ôÀàlo ä/</div>
            <div class="result-section">
              <div class="result-section-title">Definition</div>
              <div class="definition-item">
                <div class="definition-pos">interjection</div>
                <div class="definition-text">Used as a greeting or to begin a phone conversation.</div>
              </div>
            </div>
            <div class="result-section">
              <div class="result-section-title">Example</div>
              <div class="example-item">
                <em>"Hello, how are you today?"</em>
              </div>
            </div>
            <div class="result-actions">
              <button onclick="copyToClipboard('${text}')" class="action-btn action-btn-primary">
                üìã Copy
              </button>
              <button onclick="searchWikipedia('${text}')" class="action-btn action-btn-secondary">
                üìö Wikipedia
              </button>
              <button onclick="searchWeb('${text}')" class="action-btn action-btn-info">
                üîç Web Search
              </button>
            </div>
          </div>
        `;
      }

      function displayErrorResult(text, error) {
        document.getElementById('loadingElement').style.display = 'none';
        const container = document.getElementById('dictionary-results');
        container.style.display = 'block';
        container.innerHTML = `<div class="error-message">Failed to look up "${text}".<br><small>${error.message || 'Unknown error'}</small></div>`;
      }
      
             // Expose utility functions to the window object for onclick handlers
       window.searchWeb = (term) => {
         console.log('[POPUP] searchWeb called with:', term);
         if (window.electronAPI && window.electronAPI.send) {
           console.log('[POPUP] Sending search-web request to main process');
           window.electronAPI.send('search-web', term);
         } else {
           console.error('[POPUP] electronAPI.send not available');
         }
       }

       // Preload voices to ensure they're available
       let voicesLoaded = false;
       let availableVoices = [];

       function loadVoices() {
         if (voicesLoaded) return availableVoices;

         availableVoices = speechSynthesis.getVoices();
         voicesLoaded = true;

         console.log(`[AUDIO-DEBUG] Voices loaded: ${availableVoices.length} voices`);
         console.log(`[AUDIO-DEBUG] Voice list:`, availableVoices.map(v => `${v.name} (${v.lang}) [${v.default ? 'default' : 'secondary'}]`));

         return availableVoices;
       }

       // Load voices when speech synthesis becomes available
       if ('speechSynthesis' in window) {
         if (speechSynthesis.getVoices().length > 0) {
           loadVoices();
         } else {
           speechSynthesis.addEventListener('voiceschanged', loadVoices);
         }
       }

       window.playAudio = (text, language) => {
         console.log(`[AUDIO-DEBUG] === Starting audio playback ===`);
         console.log(`[AUDIO-DEBUG] Input text: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);
         console.log(`[AUDIO-DEBUG] Input language: ${language}`);

         if ('speechSynthesis' in window) {
           try {
             // Validate and clean the text
             if (!text || typeof text !== 'string') {
               console.error('[AUDIO-DEBUG] Invalid text for audio playback - text is null/undefined or not a string');
               return;
             }

             // Clean the text of problematic characters
             const cleanText = text
               .replace(/[\u200B-\u200D\uFEFF]/g, '') // Remove zero-width characters
               .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Remove control characters
               .trim();

             if (cleanText.length === 0) {
               console.error('[AUDIO-DEBUG] Text is empty after cleaning');
               return;
             }

             // Limit text length to prevent issues
             const maxLength = 500;
             const truncatedText = cleanText.length > maxLength ? cleanText.substring(0, maxLength) + '...' : cleanText;

             const guessLang = (txt) => {
               console.log(`[AUDIO-DEBUG] Running language detection on: "${txt.substring(0, 30)}${txt.length > 30 ? '...' : ''}"`);

               // Chinese characters
               if (/[\u4e00-\u9fff]/.test(txt)) {
                 console.log(`[AUDIO-DEBUG] Detected Chinese characters`);
                 return 'zh-CN';
               }
               // Japanese Hiragana/Katakana
               if (/[\u3040-\u309f\u30a0-\u30ff]/.test(txt)) {
                 console.log(`[AUDIO-DEBUG] Detected Japanese Hiragana/Katakana`);
                 return 'ja-JP';
               }
               // Korean Hangul
               if (/[\uac00-\ud7af]/.test(txt)) {
                 console.log(`[AUDIO-DEBUG] Detected Korean Hangul`);
                 return 'ko-KR';
               }
               // Cyrillic (Russian, etc.)
               if (/[\u0400-\u04ff]/.test(txt)) {
                 console.log(`[AUDIO-DEBUG] Detected Cyrillic (Russian)`);
                 return 'ru-RU';
               }
               // Arabic
               if (/[\u0600-\u06ff]/.test(txt)) {
                 console.log(`[AUDIO-DEBUG] Detected Arabic`);
                 return 'ar-SA';
               }
               // Hebrew
               if (/[\u0590-\u05ff]/.test(txt)) {
                 console.log(`[AUDIO-DEBUG] Detected Hebrew`);
                 return 'he-IL';
               }
               // Greek
               if (/[\u0370-\u03ff]/.test(txt)) {
                 console.log(`[AUDIO-DEBUG] Detected Greek`);
                 return 'el-GR';
               }

               console.log(`[AUDIO-DEBUG] No specific language detected, defaulting to English`);
               // Default to English
               return 'en-US';
             };

             // Determine language
             const detectedLang = guessLang(truncatedText);
             console.log(`[AUDIO-DEBUG] Language detection result: ${detectedLang}`);

             const utterance = new SpeechSynthesisUtterance(truncatedText);
             const lang = language ? (language === 'zh' ? 'zh-CN' : language) : detectedLang;
             utterance.lang = lang;
             utterance.rate = 0.9;

             // Enhanced voice selection with better fallback logic
             const voices = loadVoices(); // Use preloaded voices
             console.log(`[AUDIO-DEBUG] Using preloaded voices: ${voices.length} voices`);
             console.log(`[AUDIO-DEBUG] Available voices:`, voices.map(v => `${v.name} (${v.lang}) [${v.default ? 'default' : 'secondary'}]`));

             // Priority order for voice selection
             const voiceSelectionStrategies = [
               // 1. Exact language match with preferred voice names
               () => voices.find(voice =>
                 voice.lang === lang &&
                 (voice.name.toLowerCase().includes('natural') ||
                  voice.name.toLowerCase().includes('premium') ||
                  voice.name.toLowerCase().includes('female') ||
                  voice.name.toLowerCase().includes('male') ||
                  voice.default)
               ),
               // 2. Language prefix match with preferred names
               () => voices.find(voice =>
                 voice.lang.startsWith(lang.substring(0, 2)) &&
                 (voice.name.toLowerCase().includes('natural') ||
                  voice.name.toLowerCase().includes('premium') ||
                  voice.name.toLowerCase().includes('female') ||
                  voice.name.toLowerCase().includes('male') ||
                  voice.default)
               ),
               // 3. Any voice with exact language match
               () => voices.find(voice => voice.lang === lang),
               // 4. Any voice with language prefix match
               () => voices.find(voice => voice.lang.startsWith(lang.substring(0, 2))),
               // 5. Default voice as last resort
               () => voices.find(voice => voice.default),
               // 6. First available voice
               () => voices[0]
             ];

             let selectedVoice = null;
             let selectedStrategy = -1;

             for (let i = 0; i < voiceSelectionStrategies.length; i++) {
               selectedVoice = voiceSelectionStrategies[i]();
               if (selectedVoice) {
                 selectedStrategy = i;
                 break;
               }
             }

             if (selectedVoice) {
               utterance.voice = selectedVoice;
               console.log(`[AUDIO-DEBUG] Selected voice using strategy ${selectedStrategy + 1}:`, {
                 name: selectedVoice.name,
                 lang: selectedVoice.lang,
                 default: selectedVoice.default,
                 localService: selectedVoice.localService
               });
             } else {
               console.warn(`[AUDIO-DEBUG] No suitable voice found for language: ${lang}`);
               console.warn(`[AUDIO-DEBUG] Available voices:`, voices.map(v => `${v.name} (${v.lang})`));
             }

             console.log(`[AUDIO-DEBUG] Utterance setup complete - lang: ${utterance.lang}, voice: ${utterance.voice?.name || 'none'}, rate: ${utterance.rate}`);

             // Check if we have any voices for this language before attempting to speak
             const hasVoicesForLang = voices.some(voice => voice.lang.startsWith(lang.substring(0, 2)));
             if (!hasVoicesForLang) {
               console.warn(`[AUDIO-DEBUG] No voices available for ${lang}, trying English fallback`);
               utterance.lang = 'en-US';
               utterance.voice = voices.find(voice => voice.lang.startsWith('en') && voice.default) || voices.find(voice => voice.default) || null;
             }

             // Add comprehensive event handlers
             utterance.onstart = () => {
               console.log(`[AUDIO-DEBUG] Speech synthesis started successfully for ${lang}`);
             };

             utterance.onend = () => {
               console.log(`[AUDIO-DEBUG] Speech synthesis completed for ${lang}`);
             };

             utterance.onerror = (event) => {
               console.error(`[AUDIO-DEBUG] Speech synthesis error for ${lang}:`, event.error);
               console.error(`[AUDIO-DEBUG] Error details:`, {
                 error: event.error,
                 utteranceLang: utterance.lang,
                 utteranceVoice: utterance.voice?.name || 'none'
               });
             };

             console.log(`[AUDIO-DEBUG] About to call speechSynthesis.speak()`);
             speechSynthesis.cancel();
             speechSynthesis.speak(utterance);
             console.log(`[AUDIO-DEBUG] speechSynthesis.speak() called for language: ${lang}`);
           } catch (error) {
             console.error('[AUDIO-DEBUG] Error in playAudio:', error);
           }
         } else {
           console.error('[AUDIO-DEBUG] Speech synthesis not available');
         }
       }

       window.searchWikipedia = (term) => {
         console.log('[POPUP] searchWikipedia called with:', term);
         if (window.electronAPI && window.electronAPI.send) {
           console.log('[POPUP] Sending search-wikipedia request to main process');
           window.electronAPI.send('search-wikipedia', term);
         } else {
           console.error('[POPUP] electronAPI.send not available');
         }
       }

       window.copyToClipboard = (text) => {
         console.log('[POPUP] copyToClipboard called with:', text);
         if (navigator.clipboard) {
           navigator.clipboard.writeText(text).then(() => {
             console.log('[POPUP] Text copied to clipboard');
           }).catch(err => {
             console.error('[POPUP] Failed to copy to clipboard:', err);
           });
         } else {
           console.error('[POPUP] Clipboard API not available');
         }
       }

                // Add language change listeners
         document.addEventListener('DOMContentLoaded', () => {
           const sourceLanguage = document.getElementById('sourceLanguage');
           const targetLanguage = document.getElementById('targetLanguage');
           
           if (sourceLanguage && targetLanguage) {
             sourceLanguage.addEventListener('change', () => {
               if (currentText && currentTab === 'translation') {
                 lookupText(currentText);
               }
             });
             
             targetLanguage.addEventListener('change', () => {
               if (currentText && currentTab === 'translation') {
                 lookupText(currentText);
               }
             });
           }
         });

                   // Handle hyperlinks in content
           document.addEventListener('click', function(e) {
             var t = e.target || null;
             var anchor = null;
             if (t && typeof t.closest === 'function') {
               anchor = t.closest('a');
             }
             if (!anchor) return;
             e.preventDefault();
             let href = anchor.getAttribute('href') || '';
             if (!href) return;
             if (href.startsWith('/')) {
               href = `https://en.wiktionary.org${href}`;
             }
             if (settings.openExternal) {
               window.electronAPI.openExternal(href);
             } else {
               window.electronAPI.openInApp(href);
             }
           });

           async function showWikipediaPanel(term) {
             try {
               if (!window.wikipediaAPI) return;
              const result = await window.wikipediaAPI.search(term, 'en', 5);
               const resultsContainer = document.getElementById('dictionary-results');
               const loading = document.getElementById('loadingElement');
               if (loading) loading.style.display = 'none';
               if (!resultsContainer) return;
               const html = `
                  <div class="result-card" style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff">
                    <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #eef2f7;background:linear-gradient(135deg,#fdfbfb 0%,#ebedee 100%);">
                      <div style="width:28px;height:28px;border-radius:6px;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;">W</div>
                      <div style="font-weight:600;color:#1f2937;">Wikipedia</div>
                      <div style="margin-left:auto;font-size:12px;color:#6b7280">curated</div>
                    </div>
                    <div style="padding:14px 16px;">
                      ${result.results.map(r => `
                        <div style="padding:10px 0;border-bottom:1px dashed #e5e7eb;">
                          <div style="display:flex;align-items:center;gap:10px;">
                            ${r.thumbnail ? `<img src="${r.thumbnail}" alt="thumb" style="width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0;" />` : ''}
                            <a href="${r.url}" style="font-weight:600;color:#1d4ed8;text-decoration:none;">${r.title}</a>
                          </div>
                          <div style="color:#374151;margin-top:6px;line-height:1.5;">${r.extract || ''}</div>
                        </div>
                      `).join('')}
                      ${result.results.length === 0 ? `<div class="empty-state">No Wikipedia articles found</div>` : ''}
                    </div>
                  </div>`;
               resultsContainer.style.display = 'block';
               resultsContainer.innerHTML = html;
               activateTab('dictionary');
             } catch (err) {
               console.error('Wikipedia panel error', err);
             }
           }

           function showToast(msg) {
             const el = document.createElement('div');
             el.style.position = 'fixed';
             el.style.right = '10px';
             el.style.top = '10px';
             el.style.background = '#111827';
             el.style.color = '#fff';
             el.style.padding = '6px 10px';
             el.style.borderRadius = '6px';
             el.style.fontSize = '12px';
             el.textContent = msg;
             document.body.appendChild(el);
             setTimeout(() => el.remove(), 1400);
           }
    </script>
  </body>
</html>
